<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hawk Security - Supervisor Portal v3</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--hawk-red:#C41E3A;--hawk-red-dark:#9B1B2F;--hawk-blue:#1B4F8C;--hawk-gold:#D4A017;--surface:#FFF;--surface-alt:#F8F9FA;--text:#1A1A2E;--text-muted:#718096;--border:#E2E8F0;--success:#059669;--warning:#D97706;--error:#DC2626}
        body{font-family:'Segoe UI',system-ui,sans-serif;background:linear-gradient(135deg,#fef2f2,#fff7ed,#fefce8);min-height:100vh;color:var(--text)}
        .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .login-box{background:#fff;border-radius:20px;box-shadow:0 25px 50px rgba(196,30,58,0.2);width:100%;max-width:420px;overflow:hidden;border:3px solid var(--hawk-gold)}
        .login-header{background:linear-gradient(135deg,#C41E3A,#9B1B2F);padding:30px;text-align:center;color:#fff}
        .login-logo{width:100px;height:100px;margin:0 auto 15px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;overflow:hidden}
        .login-logo img{width:95%;height:95%;object-fit:contain}
        .login-title{font-size:20px;font-weight:700}
        .login-subtitle{font-size:12px;opacity:0.9;margin-top:5px}
        .login-tabs{display:flex;border-bottom:3px solid var(--hawk-gold)}
        .login-tab{flex:1;padding:14px;text-align:center;cursor:pointer;font-weight:600;color:var(--text-muted);background:var(--surface-alt);border:none}
        .login-tab.active{background:#fff;color:var(--hawk-red)}
        .login-form{padding:25px}
        .form-group{margin-bottom:18px}
        .form-group label{display:block;font-size:13px;font-weight:600;color:var(--text-muted);margin-bottom:6px}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:15px}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--hawk-red)}
        .btn{width:100%;padding:14px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer}
        .btn-primary{background:linear-gradient(135deg,#C41E3A,#9B1B2F);color:#fff}
        .btn-primary:hover{box-shadow:0 8px 20px rgba(196,30,58,0.4)}
        .btn-secondary{background:var(--surface-alt);color:var(--text);border:2px solid var(--border)}
        .btn-success{background:var(--success);color:#fff}
        .btn-danger{background:var(--error);color:#fff}
        .login-footer{text-align:center;padding:15px;background:var(--hawk-blue);color:#fff;font-size:11px}
        .login-footer a{color:var(--hawk-gold)}
        .msg{padding:10px;border-radius:8px;margin-bottom:12px;font-size:13px;display:none}
        .msg.error{background:#FEF2F2;color:var(--error);display:block}
        .msg.success{background:#ECFDF5;color:var(--success);display:block}
        .app-container{display:none;min-height:100vh}
        .app-header{background:linear-gradient(135deg,#C41E3A,#9B1B2F);padding:12px 20px;position:sticky;top:0;z-index:100}
        .header-content{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
        .header-brand{display:flex;align-items:center;gap:12px}
        .header-logo{width:45px;height:45px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;overflow:hidden}
        .header-logo img{width:90%;height:90%;object-fit:contain}
        .header-title{color:#fff}
        .header-title h1{font-size:16px}
        .header-title p{font-size:10px;opacity:0.9}
        .header-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
        .header-btn{padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer;border:2px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#fff}
        .header-btn:hover{background:rgba(255,255,255,0.2)}
        .user-info{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,0.15);border-radius:8px}
        .user-avatar{width:32px;height:32px;background:var(--hawk-gold);border-radius:6px;display:flex;align-items:center;justify-content:center;color:var(--hawk-red-dark);font-weight:700;font-size:12px}
        .user-name{font-size:12px;font-weight:600;color:#fff}
        .user-role{font-size:10px;color:rgba(255,255,255,0.8)}
        .nav-tabs{background:var(--hawk-blue);border-bottom:3px solid var(--hawk-gold)}
        .nav-tabs-inner{max-width:1400px;margin:0 auto;display:flex;gap:5px;padding:0 20px;overflow-x:auto}
        .nav-tab{padding:12px 18px;font-size:13px;color:rgba(255,255,255,0.8);cursor:pointer;border:none;background:none;border-bottom:3px solid transparent;white-space:nowrap;margin-bottom:-3px}
        .nav-tab:hover{color:#fff}
        .nav-tab.active{color:var(--hawk-gold);border-bottom-color:var(--hawk-gold)}
        .main-content{max-width:1400px;margin:0 auto;padding:25px 20px}
        .tab-content{display:none}.tab-content.active{display:block}
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin-bottom:25px}
        .stat-card{background:#fff;border-radius:14px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.06);border-left:4px solid var(--hawk-red)}
        .stat-card.primary{background:linear-gradient(135deg,#C41E3A,#9B1B2F);color:#fff;border:none}
        .stat-card.blue{background:linear-gradient(135deg,#1B4F8C,#153D6B);color:#fff;border:none}
        .stat-value{font-size:28px;font-weight:700}
        .stat-label{font-size:13px;opacity:0.8;margin-top:4px}
        .progress-bar-bg{background:rgba(255,255,255,0.3);height:8px;border-radius:4px;margin-top:12px;overflow:hidden}
        .progress-bar{height:100%;background:var(--hawk-gold);border-radius:4px}
        .reports-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px}
        .report-card{background:#fff;border-radius:14px;padding:18px;border:2px solid var(--border);cursor:pointer;position:relative}
        .report-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--hawk-gold);border-radius:14px 0 0 14px}
        .report-card:hover{border-color:var(--hawk-red);box-shadow:0 8px 25px rgba(196,30,58,0.15)}
        .report-card.done{background:var(--surface-alt);opacity:0.7;cursor:default}
        .report-card.done:hover{box-shadow:none;border-color:var(--border)}
        .report-card.done::before{background:var(--success)}
        .report-icon{width:45px;height:45px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:10px}
        .report-title{font-size:15px;font-weight:600;color:var(--hawk-red-dark)}
        .report-desc{font-size:12px;color:var(--text-muted);margin-top:3px}
        .report-status{display:inline-block;padding:4px 10px;border-radius:15px;font-size:11px;font-weight:600;margin-top:10px}
        .report-status.pending{background:#FEF3C7;color:#D97706}
        .report-status.completed{background:#D1FAE5;color:#059669}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
        .modal-overlay.active{display:flex}
        .modal{background:#fff;border-radius:18px;width:100%;max-width:850px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;border:3px solid var(--hawk-gold)}
        .modal-header{padding:18px;background:linear-gradient(135deg,#C41E3A,#9B1B2F);color:#fff;display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:17px;font-weight:700}
        .modal-close{width:34px;height:34px;border-radius:8px;border:none;background:rgba(255,255,255,0.2);cursor:pointer;font-size:18px;color:#fff}
        .modal-body{padding:22px;overflow-y:auto;flex:1}
        .modal-footer{padding:16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;background:var(--surface-alt)}
        .modal-footer .btn{width:auto;padding:10px 22px}
        .section-box{background:#fff;border-radius:14px;padding:22px;margin-bottom:18px;border-top:4px solid var(--hawk-red)}
        .section-box h3{margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);color:var(--hawk-red-dark);font-size:16px;display:flex;align-items:center;gap:10px}
        .data-table{width:100%;border-collapse:collapse;font-size:13px}
        .data-table th{background:var(--hawk-blue);color:#fff;padding:10px;text-align:left}
        .data-table td{padding:10px;border-bottom:1px solid var(--border)}
        .data-table tr:hover{background:var(--surface-alt)}
        .import-box{background:linear-gradient(135deg,#fef2f2,#fff7ed);border:2px dashed var(--hawk-red);border-radius:14px;padding:25px;text-align:center;margin-bottom:18px}
        .import-box h4{color:var(--hawk-red);margin-bottom:10px}
        .import-box p{color:var(--text-muted);margin-bottom:15px;font-size:13px}
        .import-box input[type="file"]{display:none}
        .import-box label{display:inline-block;padding:12px 24px;background:var(--hawk-red);color:#fff;border-radius:8px;cursor:pointer;font-weight:600;margin:5px}
        .import-box label:hover{background:var(--hawk-red-dark)}
        .entry-row{background:var(--surface-alt);border-radius:10px;padding:15px;margin-bottom:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;align-items:end;border-left:3px solid var(--hawk-blue)}
        .entry-row input,.entry-row select,.entry-row textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px}
        .entry-row label{font-size:11px;color:var(--text-muted);display:block;margin-bottom:3px}
        .add-entry-btn{width:100%;padding:12px;background:#fff;border:2px dashed var(--hawk-blue);border-radius:10px;color:var(--hawk-blue);cursor:pointer;font-weight:500}
        .remove-btn{padding:6px 10px;background:#FEF2F2;color:var(--error);border:none;border-radius:6px;cursor:pointer}
        .toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:2000}
        .toast{padding:12px 22px;border-radius:10px;color:#fff;font-weight:500;margin-top:8px;animation:slideUp 0.3s}
        .toast.success{background:var(--success)}.toast.error{background:var(--error)}.toast.warning{background:var(--warning)}.toast.info{background:var(--hawk-blue)}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .hidden{display:none!important}
        @media(max-width:768px){.header-content{flex-direction:column}.dashboard-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo" id="loginLogo">ü¶Ö</div>
                <div class="login-title">Supervisor Portal v3</div>
                <div class="login-subtitle">Hawk Security Services LLC</div>
            </div>
            <div class="login-tabs">
                <button class="login-tab active" onclick="showLoginTab('login')">Login</button>
                <button class="login-tab" onclick="showLoginTab('register')">Register</button>
            </div>
            <div id="loginPane" class="login-form">
                <div id="loginMsg" class="msg"></div>
                <div class="form-group"><label>Employee ID</label><input type="text" id="loginId" placeholder="e.g., SUP001"></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPw" placeholder="Enter password"></div>
                <button class="btn btn-primary" onclick="doLogin()">üîê Login</button>
                <p style="text-align:center;margin-top:12px;font-size:12px;color:var(--text-muted);">Demo: SUP001/hawk123 | MGR001/manager123</p>
            </div>
            <div id="registerPane" class="login-form hidden">
                <div id="regMsg" class="msg"></div>
                <div class="form-group"><label>Employee ID *</label><input type="text" id="regId" placeholder="e.g., SUP003"></div>
                <div class="form-group"><label>Full Name *</label><input type="text" id="regName" placeholder="Your full name"></div>
                <div class="form-group"><label>Designation</label><select id="regRole"><option>Supervisor</option><option>Senior Supervisor</option><option>Operations Supervisor</option></select></div>
                <div class="form-group"><label>Password *</label><input type="password" id="regPw" placeholder="Min 6 characters"></div>
                <div class="form-group"><label>Confirm Password *</label><input type="password" id="regPw2"></div>
                <button class="btn btn-primary" onclick="doRegister()">üìù Create Account</button>
            </div>
            <div class="login-footer">¬© 2026 Hawk Security Services LLC | <a href="https://www.hawksecurityservice.com" target="_blank">www.hawksecurityservice.com</a></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appScreen" class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div class="header-brand">
                    <div class="header-logo" id="headerLogo">ü¶Ö</div>
                    <div class="header-title"><h1>Supervisor Portal v3</h1><p>Hawk Security Services LLC</p></div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="loadData()">üîÑ Refresh</button>
                    <button class="header-btn" onclick="exportData()">üì§ Export</button>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">YU</div>
                        <div><div id="userName" class="user-name">User</div><div id="userRole" class="user-role">Role</div></div>
                    </div>
                    <button class="header-btn" onclick="doLogout()">üö™</button>
                </div>
            </div>
        </header>
        <nav class="nav-tabs">
            <div class="nav-tabs-inner">
                <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
                <button class="nav-tab" data-tab="reports">üìù Reports</button>
                <button class="nav-tab" data-tab="history">üìú History</button>
                <button class="nav-tab management-only" data-tab="management">üëî Management</button>
                <button class="nav-tab" data-tab="data">üóÑÔ∏è Sites & Employees</button>
            </div>
        </nav>
        <main class="main-content">
            <!-- DASHBOARD TAB -->
            <div id="dashboardTab" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card primary"><div class="stat-value" id="statCompleted">0/10</div><div class="stat-label">Your Reports</div><div class="progress-bar-bg"><div class="progress-bar" id="progressBar" style="width:0%"></div></div></div>
                    <div class="stat-card blue"><div class="stat-value" id="statSites">0</div><div class="stat-label">Sites</div></div>
                    <div class="stat-card"><div class="stat-value" id="statEmps">0</div><div class="stat-label">Employees</div></div>
                    <div class="stat-card"><div class="stat-value" id="statDays">0</div><div class="stat-label">Days Left</div></div>
                </div>
                <h3 style="margin-bottom:16px;color:var(--hawk-red-dark);">üìù Pending Reports</h3>
                <div class="reports-grid" id="pendingGrid"></div>
            </div>
            
            <!-- REPORTS TAB -->
            <div id="reportsTab" class="tab-content">
                <h2 style="margin-bottom:18px;color:var(--hawk-red-dark);">Monthly Reports - <span id="periodLabel"></span></h2>
                <div class="reports-grid" id="allReportsGrid"></div>
            </div>
            
            <!-- HISTORY TAB -->
            <div id="historyTab" class="tab-content">
                <h2 style="margin-bottom:18px;color:var(--hawk-red-dark);">üìú Your Submitted Reports</h2>
                <div id="historyList"></div>
            </div>
            
            <!-- MANAGEMENT TAB -->
            <div id="managementTab" class="tab-content">
                <h2 style="margin-bottom:18px;color:var(--hawk-red-dark);">üëî Management Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="stat-card primary"><div class="stat-value" id="mgrTotalReports">0</div><div class="stat-label">Total Reports This Month</div></div>
                    <div class="stat-card blue"><div class="stat-value" id="mgrSupervisors">0</div><div class="stat-label">Supervisors</div></div>
                </div>
                <div class="section-box"><h3>üìä Reports by Supervisor</h3><div id="supervisorBreakdown"></div></div>
                <div class="section-box"><h3>üìã All Reports This Month</h3><div id="allReportsList"></div></div>
            </div>
            
            <!-- DATA TAB - IMPORT SITES & EMPLOYEES -->
            <div id="dataTab" class="tab-content">
                <!-- SITES IMPORT -->
                <div class="import-box">
                    <h4>üì• Import Sites/Clients</h4>
                    <p>Upload CSV or JSON file with columns: SiteID, Name, Client, Location, Type, ContactPerson</p>
                    <input type="file" id="sitesFile" accept=".csv,.json" onchange="importSites(event)">
                    <label for="sitesFile">üìÅ Choose File</label>
                    <button class="btn btn-secondary" style="width:auto;padding:10px 20px;margin:5px" onclick="downloadSitesTemplate()">üìÑ Download Template</button>
                </div>
                
                <div class="section-box">
                    <h3>üè¢ Sites/Clients (<span id="siteCount">0</span>) 
                        <button class="btn btn-danger" style="width:auto;padding:5px 15px;font-size:12px;margin-left:auto" onclick="clearSites()">Clear All</button>
                    </h3>
                    <div style="overflow-x:auto;">
                        <table class="data-table" id="sitesTable">
                            <thead><tr><th>ID</th><th>Client Name</th><th>Location</th><th>Type</th><th>Contact</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- EMPLOYEES IMPORT -->
                <div class="import-box">
                    <h4>üì• Import Employees</h4>
                    <p>Upload CSV or JSON file with columns: EmpID, Name, Designation, Site, Status</p>
                    <input type="file" id="empsFile" accept=".csv,.json" onchange="importEmployees(event)">
                    <label for="empsFile">üìÅ Choose File</label>
                    <button class="btn btn-secondary" style="width:auto;padding:10px 20px;margin:5px" onclick="downloadEmpsTemplate()">üìÑ Download Template</button>
                </div>
                
                <div class="section-box">
                    <h3>üë• Employees (<span id="empCount">0</span>)
                        <button class="btn btn-danger" style="width:auto;padding:5px 15px;font-size:12px;margin-left:auto" onclick="clearEmployees()">Clear All</button>
                    </h3>
                    <div style="overflow-x:auto;">
                        <table class="data-table" id="empsTable">
                            <thead><tr><th>ID</th><th>Name</th><th>Designation</th><th>Site</th><th>Status</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- REPORT MODAL -->
    <div id="reportModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title"><span id="rptIcon">üìù</span> <span id="rptTitle">Report</span></div>
                <button class="modal-close" onclick="hideModal('reportModal')">√ó</button>
            </div>
            <div class="modal-body" id="reportFormBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('reportModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitReport()">‚úì Submit Report</button>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

<script>
const API = '';
const REPORTS = [
    { id: 'site_survey', name: 'Site Survey Summary', icon: 'üè¢', desc: 'Site visit tracking' },
    { id: 'customer_feedback', name: 'Customer Feedback', icon: '‚≠ê', desc: 'Client satisfaction forms' },
    { id: 'collection_report', name: 'Collection Report', icon: 'üí∞', desc: 'Payment collections' },
    { id: 'sales_leads', name: 'Sales Reference', icon: 'üìà', desc: 'New business leads' },
    { id: 'night_patrolling', name: 'Night Patrolling', icon: 'üåô', desc: 'Patrolling roster' },
    { id: 'training_summary', name: 'Training Summary', icon: 'üéì', desc: 'Staff training records' },
    { id: 'complaints', name: 'Complaints Login', icon: '‚ö†Ô∏è', desc: 'Issue tracking' },
    { id: 'accommodation', name: 'Accommodation Inspection', icon: 'üè†', desc: 'Staff housing checks' },
    { id: 'mobilization', name: 'Mobilization Report', icon: 'üë•', desc: 'Staff deployment' },
    { id: 'disciplinary', name: 'Disciplinary Actions', icon: 'üõ°Ô∏è', desc: 'Warnings & fines' }
];

let user = null, sites = [], employees = [], reports = [];
let currentReport = null, formData = { entries: [] };

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    const saved = sessionStorage.getItem('hawk_user');
    if (saved) { user = JSON.parse(saved); showApp(); }
    document.querySelectorAll('.nav-tab').forEach(t => {
        t.addEventListener('click', () => {
            document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.getElementById(t.dataset.tab + 'Tab').classList.add('active');
        });
    });
});

// API Helper
async function api(endpoint, method = 'GET', data = null) {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (data) opts.body = JSON.stringify(data);
    const res = await fetch(API + endpoint, opts);
    return res.json();
}

// Auth Functions
function showLoginTab(tab) {
    document.querySelectorAll('.login-tab').forEach((t, i) => t.classList.toggle('active', (tab === 'login' ? i === 0 : i === 1)));
    document.getElementById('loginPane').classList.toggle('hidden', tab !== 'login');
    document.getElementById('registerPane').classList.toggle('hidden', tab === 'login');
}

async function doLogin() {
    const empId = document.getElementById('loginId').value.trim();
    const password = document.getElementById('loginPw').value;
    if (!empId || !password) { showMsg('loginMsg', 'Enter both fields', 'error'); return; }
    try {
        const res = await api('/api/auth/login', 'POST', { empId, password });
        if (res.error) showMsg('loginMsg', res.error, 'error');
        else { user = res.user; sessionStorage.setItem('hawk_user', JSON.stringify(user)); showApp(); toast('Welcome, ' + user.name, 'success'); }
    } catch (e) { showMsg('loginMsg', 'Connection error', 'error'); }
}

async function doRegister() {
    const empId = document.getElementById('regId').value.trim();
    const name = document.getElementById('regName').value.trim();
    const role = document.getElementById('regRole').value;
    const password = document.getElementById('regPw').value;
    const pw2 = document.getElementById('regPw2').value;
    if (!empId || !name || !password) { showMsg('regMsg', 'Fill all required fields', 'error'); return; }
    if (password.length < 6) { showMsg('regMsg', 'Password min 6 characters', 'error'); return; }
    if (password !== pw2) { showMsg('regMsg', 'Passwords do not match', 'error'); return; }
    try {
        const res = await api('/api/auth/register', 'POST', { empId, name, role, password });
        if (res.error) showMsg('regMsg', res.error, 'error');
        else { showMsg('regMsg', 'Account created! You can now login.', 'success'); setTimeout(() => showLoginTab('login'), 1500); }
    } catch (e) { showMsg('regMsg', 'Connection error', 'error'); }
}

function doLogout() { if (confirm('Logout?')) { user = null; sessionStorage.removeItem('hawk_user'); location.reload(); } }
function showMsg(id, msg, type) { const el = document.getElementById(id); el.textContent = msg; el.className = 'msg ' + type; }

function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';
    document.getElementById('userAvatar').textContent = user.name.substring(0, 2).toUpperCase();
    document.getElementById('userName').textContent = user.name;
    document.getElementById('userRole').textContent = user.role;
    document.querySelectorAll('.management-only').forEach(el => el.style.display = user.isAdmin ? '' : 'none');
    loadData();
}

async function loadData() {
    try {
        const [sitesRes, empsRes, reportsRes] = await Promise.all([
            api('/api/sites'), api('/api/employees'), api('/api/reports?supervisorId=' + user.empId)
        ]);
        sites = sitesRes || [];
        employees = empsRes || [];
        reports = reportsRes || [];
        document.getElementById('periodLabel').textContent = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        updateDashboard();
        updateTables();
        renderReports();
        renderHistory();
        if (user.isAdmin) loadManagement();
    } catch (e) { toast('Error loading data', 'error'); console.error(e); }
}

async function loadManagement() {
    try {
        const stats = await api('/api/reports/stats');
        document.getElementById('mgrTotalReports').textContent = stats.totalReports;
        document.getElementById('mgrSupervisors').textContent = stats.totalSupervisors;
        let html = '<table class="data-table"><thead><tr><th>Supervisor</th><th>Submitted</th><th>Pending</th></tr></thead><tbody>';
        for (const [id, data] of Object.entries(stats.bySupervisor || {})) {
            html += `<tr><td>${data.name}</td><td>${data.reports.length}/10</td><td>${10 - data.reports.length}</td></tr>`;
        }
        html += '</tbody></table>';
        document.getElementById('supervisorBreakdown').innerHTML = html || '<p>No reports yet</p>';
        const allReports = await api('/api/reports');
        let rptHtml = '<table class="data-table"><thead><tr><th>Report</th><th>Supervisor</th><th>Date</th></tr></thead><tbody>';
        allReports.slice(0, 50).forEach(r => {
            const rt = REPORTS.find(x => x.id === r.reportType);
            rptHtml += `<tr><td>${rt ? rt.icon + ' ' + rt.name : r.reportType}</td><td>${r.supervisorName}</td><td>${new Date(r.submittedAt).toLocaleDateString()}</td></tr>`;
        });
        rptHtml += '</tbody></table>';
        document.getElementById('allReportsList').innerHTML = rptHtml;
    } catch (e) { console.error(e); }
}

function updateTables() {
    document.querySelector('#sitesTable tbody').innerHTML = sites.map(s => 
        `<tr><td>${s.siteId || s.id}</td><td>${s.name || s.client}</td><td>${s.location || '-'}</td><td>${s.type || '-'}</td><td>${s.contactPerson || '-'}</td></tr>`
    ).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">No sites - Import from CSV/JSON above</td></tr>';
    document.getElementById('siteCount').textContent = sites.length;
    
    document.querySelector('#empsTable tbody').innerHTML = employees.map(e => 
        `<tr><td>${e.empId || e.id}</td><td>${e.name}</td><td>${e.type || e.designation || '-'}</td><td>${e.siteId || e.site || '-'}</td><td>${e.status || 'Active'}</td></tr>`
    ).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">No employees - Import from CSV/JSON above</td></tr>';
    document.getElementById('empCount').textContent = employees.length;
}

function updateDashboard() {
    const now = new Date(), m = now.getMonth() + 1, y = now.getFullYear();
    const done = reports.filter(r => r.periodMonth === m && r.periodYear === y).map(r => r.reportType);
    document.getElementById('statCompleted').textContent = done.length + '/10';
    document.getElementById('progressBar').style.width = (done.length * 10) + '%';
    document.getElementById('statSites').textContent = sites.length;
    document.getElementById('statEmps').textContent = employees.length;
    const deadline = new Date(y, m, 5);
    document.getElementById('statDays').textContent = Math.max(0, Math.ceil((deadline - now) / 86400000));
    document.getElementById('pendingGrid').innerHTML = REPORTS.filter(r => !done.includes(r.id)).slice(0, 4).map(r => reportCard(r, false)).join('');
}

function renderReports() {
    const now = new Date(), m = now.getMonth() + 1, y = now.getFullYear();
    const done = reports.filter(r => r.periodMonth === m && r.periodYear === y).map(r => r.reportType);
    document.getElementById('allReportsGrid').innerHTML = REPORTS.map(r => reportCard(r, done.includes(r.id))).join('');
}

function reportCard(r, isDone) {
    return `<div class="report-card ${isDone ? 'done' : ''}" onclick="${isDone ? '' : "openReport('" + r.id + "')"}">
        <div class="report-icon" style="background:${isDone ? '#D1FAE5' : '#FEF3C7'}">${r.icon}</div>
        <div class="report-title">${r.name}</div>
        <div class="report-desc">${r.desc}</div>
        <span class="report-status ${isDone ? 'completed' : 'pending'}">${isDone ? '‚úì Done' : '‚è≥ Pending'}</span>
    </div>`;
}

function renderHistory() {
    if (!reports.length) { document.getElementById('historyList').innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:30px">No reports submitted yet</p>'; return; }
    const sorted = [...reports].sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
    document.getElementById('historyList').innerHTML = `<div class="section-box"><table class="data-table"><thead><tr><th>Report</th><th>Period</th><th>Date</th></tr></thead><tbody>
        ${sorted.map(r => { const rt = REPORTS.find(x => x.id === r.reportType); return `<tr><td>${rt ? rt.icon + ' ' + rt.name : r.reportType}</td><td>${r.periodLabel || ''}</td><td>${new Date(r.submittedAt).toLocaleDateString()}</td></tr>`; }).join('')}
    </tbody></table></div>`;
}

// ==================== IMPORT FUNCTIONS ====================

function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    return lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i] || '');
        return obj;
    });
}

async function importSites(event) {
    const file = event.target.files[0];
    if (!file) return;
    try {
        const text = await file.text();
        let data;
        if (file.name.endsWith('.json')) {
            data = JSON.parse(text);
            if (!Array.isArray(data)) data = data.sites || [data];
        } else {
            data = parseCSV(text);
        }
        const res = await api('/api/sites/import', 'POST', { sites: data, replace: false });
        if (res.error) toast(res.error, 'error');
        else { toast(`Imported ${res.imported} sites!`, 'success'); loadData(); }
    } catch (e) { toast('Import failed: ' + e.message, 'error'); }
    event.target.value = '';
}

async function importEmployees(event) {
    const file = event.target.files[0];
    if (!file) return;
    try {
        const text = await file.text();
        let data;
        if (file.name.endsWith('.json')) {
            data = JSON.parse(text);
            if (!Array.isArray(data)) data = data.employees || [data];
        } else {
            data = parseCSV(text);
        }
        const res = await api('/api/employees/import', 'POST', { employees: data, replace: false });
        if (res.error) toast(res.error, 'error');
        else { toast(`Imported ${res.imported} employees!`, 'success'); loadData(); }
    } catch (e) { toast('Import failed: ' + e.message, 'error'); }
    event.target.value = '';
}

function downloadSitesTemplate() {
    const csv = 'siteId,name,client,location,type,contactPerson,manningRequired\nSITE001,Dubai Mall,Emaar Properties,Downtown Dubai,Mall,John Smith,10\nSITE002,Intercontinental Hotel,IHG Group,Festival City,Hotel,Jane Doe,5';
    downloadFile('sites_template.csv', csv);
}

function downloadEmpsTemplate() {
    const csv = 'empId,name,type,siteId,status,phone\nEMP001,Ahmed Hassan,Security Guard,SITE001,Active,+971501234567\nEMP002,Mohammed Ali,Cleaner,SITE002,Active,+971507654321';
    downloadFile('employees_template.csv', csv);
}

function downloadFile(filename, content) {
    const blob = new Blob([content], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
}

async function clearSites() {
    if (!confirm('Delete ALL sites? This cannot be undone.')) return;
    await api('/api/sites/all', 'DELETE');
    toast('All sites cleared', 'success');
    loadData();
}

async function clearEmployees() {
    if (!confirm('Delete ALL employees? This cannot be undone.')) return;
    await api('/api/employees/all', 'DELETE');
    toast('All employees cleared', 'success');
    loadData();
}

// ==================== REPORT FORM ====================

function openReport(id) {
    currentReport = REPORTS.find(r => r.id === id);
    if (!currentReport) return;
    formData = { entries: [{}] };
    document.getElementById('rptIcon').textContent = currentReport.icon;
    document.getElementById('rptTitle').textContent = currentReport.name + ' - ' + new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    renderReportForm();
    showModal('reportModal');
}

function getFieldsForReport(id) {
    const configs = {
        site_survey: [
            { k: 'date', l: 'Date', t: 'date' },
            { k: 'clientName', l: 'Client Name', t: 'site' },
            { k: 'location', l: 'Location', t: 'text' },
            { k: 'manningRequired', l: 'Manning Required', t: 'number' },
            { k: 'contactPerson', l: 'Contact Person', t: 'text' },
            { k: 'surveyDoneBy', l: 'Survey Done By', t: 'text' }
        ],
        customer_feedback: [
            { k: 'date', l: 'Date', t: 'date' },
            { k: 'clientName', l: 'Client', t: 'site' },
            { k: 'location', l: 'Location', t: 'text' },
            { k: 'serviceType', l: 'Service Type', t: 'select', o: ['Security Guard Services', 'Cleaning Services', 'Office Support Services', 'Others'] },
            { k: 'personnel', l: 'No. of Personnel', t: 'number' },
            { k: 'assessment', l: 'Assessment', t: 'select', o: ['Satisfied', 'Good', 'Outstanding'] },
            { k: 'comments', l: 'Comments', t: 'text' }
        ],
        collection_report: [
            { k: 'date', l: 'Collection Date', t: 'date' },
            { k: 'clientName', l: 'Client Name', t: 'site' },
            { k: 'invoiceNo', l: 'Invoice No', t: 'text' },
            { k: 'paymentMode', l: 'Payment Mode', t: 'select', o: ['Cash', 'Cheque', 'Bank Transfer', 'Online'] },
            { k: 'amount', l: 'Amount (AED)', t: 'number' }
        ],
        sales_leads: [
            { k: 'sourceDate', l: 'Source Date', t: 'date' },
            { k: 'clientName', l: 'Client Name', t: 'text' },
            { k: 'contactPerson', l: 'Contact Person', t: 'text' },
            { k: 'quantity', l: 'Quantity/Guards', t: 'text' },
            { k: 'serviceType', l: 'Type of Service', t: 'select', o: ['Annual Contract', 'Event Security', 'Cleaning', 'Others'] },
            { k: 'status', l: 'Status', t: 'select', o: ['Open', 'Won', 'Lost', 'Follow-up'] },
            { k: 'description', l: 'Activity Description', t: 'textarea' }
        ],
        night_patrolling: [
            { k: 'date', l: 'Date', t: 'date' },
            { k: 'site', l: 'Site', t: 'site' },
            { k: 'timeIn', l: 'Time In', t: 'time' },
            { k: 'timeOut', l: 'Time Out', t: 'time' },
            { k: 'findings', l: 'Findings', t: 'select', o: ['All Clear', 'Minor Issue', 'Major Issue'] },
            { k: 'remarks', l: 'Remarks', t: 'text' }
        ],
        training_summary: [
            { k: 'date', l: 'Date', t: 'date' },
            { k: 'time', l: 'Time', t: 'time' },
            { k: 'clientName', l: 'Client Name', t: 'site' },
            { k: 'location', l: 'Location', t: 'text' },
            { k: 'trainingType', l: 'Training Type', t: 'select', o: ['Fire Safety', 'First Aid', 'Security Procedures', 'Customer Service', 'Health & Safety', 'Others'] },
            { k: 'attendees', l: 'Count Attended', t: 'number' }
        ],
        complaints: [
            { k: 'date', l: 'Date', t: 'date' },
            { k: 'clientName', l: 'Client Name', t: 'site' },
            { k: 'nature', l: 'Nature of Complaint', t: 'select', o: ['Service Quality', 'Staff Behavior', 'Attendance', 'Safety', 'Others'] },
            { k: 'personsInvolved', l: 'Persons Involved', t: 'text' },
            { k: 'action', l: 'Course of Action', t: 'textarea' },
            { k: 'status', l: 'Status', t: 'select', o: ['Open', 'In Progress', 'Closed'] },
            { k: 'clientSatisfied', l: 'Client Satisfied?', t: 'select', o: ['Yes', 'No', 'Pending'] }
        ],
        accommodation: [
            { k: 'date', l: 'Inspection Date', t: 'date' },
            { k: 'inspectionBy', l: 'Inspection Done By', t: 'text' },
            { k: 'location', l: 'Location', t: 'text' },
            { k: 'remarks', l: 'Remarks', t: 'textarea' }
        ],
        mobilization: [
            { k: 'actionType', l: 'Action Type', t: 'select', o: ['Mobilization', 'Demobilization'] },
            { k: 'date', l: 'Date', t: 'date' },
            { k: 'clientName', l: 'Client Name', t: 'site' },
            { k: 'location', l: 'Location', t: 'text' },
            { k: 'serviceType', l: 'Type of Service', t: 'select', o: ['Security Guard', 'Cleaning', 'Office Support', 'Others'] },
            { k: 'guardsMale', l: 'Guards (Male)', t: 'number' },
            { k: 'guardsFemale', l: 'Guards (Female)', t: 'number' },
            { k: 'remarks', l: 'Remarks', t: 'text' }
        ],
        disciplinary: [
            { k: 'date', l: 'Date', t: 'date' },
            { k: 'employeeName', l: 'Employee Name', t: 'employee' },
            { k: 'site', l: 'Site', t: 'site' },
            { k: 'actionType', l: 'Action Type', t: 'select', o: ['Verbal Warning', 'Written Warning', 'Fine', 'Suspension', 'Termination'] },
            { k: 'reason', l: 'Reason', t: 'textarea' },
            { k: 'amount', l: 'Fine Amount (AED)', t: 'number' }
        ]
    };
    return configs[id] || configs.site_survey;
}

function renderReportForm() {
    const fields = getFieldsForReport(currentReport.id);
    let html = `<p style="margin-bottom:15px;color:var(--text-muted)">Fill in the details for this month's report. Add multiple entries if needed.</p>`;
    html += `<div id="entriesContainer">${formData.entries.map((e, i) => entryRow(fields, e, i)).join('')}</div>`;
    html += `<button class="add-entry-btn" onclick="addEntry()">+ Add Another Entry</button>`;
    document.getElementById('reportFormBody').innerHTML = html;
}

function entryRow(fields, data, idx) {
    let html = `<div class="entry-row" data-idx="${idx}">`;
    fields.forEach(f => {
        const val = data[f.k] || '';
        html += `<div><label>${f.l}</label>`;
        if (f.t === 'select') {
            html += `<select onchange="updateEntry(${idx},'${f.k}',this.value)"><option value="">-- Select --</option>${f.o.map(o => `<option value="${o}" ${val === o ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
        } else if (f.t === 'site') {
            html += `<select onchange="updateEntry(${idx},'${f.k}',this.value)"><option value="">-- Select Site --</option>${sites.map(s => `<option value="${s.name || s.client}" ${val === (s.name || s.client) ? 'selected' : ''}>${s.name || s.client}</option>`).join('')}</select>`;
        } else if (f.t === 'employee') {
            html += `<select onchange="updateEntry(${idx},'${f.k}',this.value)"><option value="">-- Select Employee --</option>${employees.map(e => `<option value="${e.name}" ${val === e.name ? 'selected' : ''}>${e.name}</option>`).join('')}</select>`;
        } else if (f.t === 'textarea') {
            html += `<textarea rows="2" onchange="updateEntry(${idx},'${f.k}',this.value)">${val}</textarea>`;
        } else {
            html += `<input type="${f.t}" value="${val}" onchange="updateEntry(${idx},'${f.k}',this.value)">`;
        }
        html += '</div>';
    });
    html += `<div style="display:flex;align-items:end"><button class="remove-btn" onclick="removeEntry(${idx})">‚úï</button></div></div>`;
    return html;
}

function updateEntry(idx, key, val) { formData.entries[idx] = formData.entries[idx] || {}; formData.entries[idx][key] = val; }
function addEntry() { formData.entries.push({}); renderReportForm(); }
function removeEntry(idx) { if (formData.entries.length > 1) { formData.entries.splice(idx, 1); renderReportForm(); } }

async function submitReport() {
    const validEntries = formData.entries.filter(e => Object.values(e).some(v => v && v.toString().trim()));
    if (!validEntries.length) { toast('Add at least one entry with data', 'warning'); return; }
    
    const now = new Date();
    const payload = {
        reportType: currentReport.id,
        period: { month: now.getMonth() + 1, year: now.getFullYear(), label: now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) },
        supervisor: { empId: user.empId, name: user.name },
        data: { entries: validEntries, submittedBy: user.name, submittedAt: now.toISOString() }
    };
    
    try {
        const res = await api('/api/reports', 'POST', payload);
        if (res.error) { toast(res.error, 'error'); return; }
        toast('Report submitted successfully!', 'success');
        hideModal('reportModal');
        loadData();
    } catch (e) { toast('Submission failed', 'error'); }
}

// ==================== EXPORT ====================

async function exportData() {
    try {
        const backup = await api('/api/backup');
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `hawk_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        toast('Backup exported', 'success');
    } catch (e) { toast('Export failed', 'error'); }
}

// ==================== UTILITIES ====================

function showModal(id) { document.getElementById(id).classList.add('active'); }
function hideModal(id) { document.getElementById(id).classList.remove('active'); }
function toast(msg, type = 'info') {
    const c = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(() => t.remove(), 3500);
}
</script>
</body>
</html>
